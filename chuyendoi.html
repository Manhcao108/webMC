<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Trung t√¢m chuy·ªÉn ƒë·ªïi file</title>
  <!-- S·ª≠ d·ª•ng version FFmpeg ·ªïn ƒë·ªãnh h∆°n: 0.12.10 t·ª´ unpkg (thay v√¨ cdnjs n·∫øu l·ªói) -->
  <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.10/dist/umd/ffmpeg.js"></script>
  <style>
    body {
      font-family: "Inter", sans-serif;
      background: linear-gradient(135deg, #f5f7fa, #e4ecf7);
      text-align: center;
      margin: 0;
      padding: 40px 20px;
      color: #333;
    }
    h1 {
      color: #3b82f6;
      margin-bottom: 10px;
      font-size: 2rem;
    }
    p {
      color: #555;
      margin-bottom: 25px;
    }
    .card {
      background: #fff;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
      max-width: 500px;
      margin: auto;
    }
    .options {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 20px;
    }
    button.option {
      background: #f3f4f6;
      border: 1px solid #d1d5db;
      padding: 12px;
      border-radius: 10px;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s;
    }
    button.option:hover, button.option.active {
      background: #3b82f6;
      color: #fff;
      border-color: #3b82f6;
      transform: scale(1.03);
    }
    input[type=file], .action-btn {
      margin-top: 15px;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: 1rem;
      width: 100%;
      max-width: 320px;
    }
    .action-btn {
      background: #3b82f6;
      color: white;
      border: none;
      cursor: pointer;
      transition: 0.3s;
    }
    .action-btn:hover {
      background: #2563eb;
    }
    #progress {
      margin-top: 15px;
      color: #555;
      font-style: italic;
    }
    a#download {
      display: none;
      margin-top: 15px;
      text-decoration: none;
      background: #10b981;
      color: white;
      padding: 10px 18px;
      border-radius: 10px;
    }
    a#download:hover {
      background: #059669;
    }
    /* Th√™m style cho l·ªói */
    .error {
      color: #ef4444;
      background: #fef2f2;
      padding: 10px;
      border-radius: 8px;
      margin-top: 10px;
      border: 1px solid #fecaca;
    }
  </style>
</head>
<body>
<h1>üîÑ Trung t√¢m chuy·ªÉn ƒë·ªïi file</h1>
<p>Chuy·ªÉn ƒë·ªïi nhanh c√°c ƒë·ªãnh d·∫°ng ph·ªï bi·∫øn ngay trong tr√¨nh duy·ªát. (L∆∞u √Ω: Video ‚Üí GIF c√≥ th·ªÉ m·∫•t 10-30s l·∫ßn ƒë·∫ßu do load FFmpeg).</p>

<div class="card">
  <div class="options">
    <button class="option" data-type="video">üé¨ Video ‚Üí GIF</button>
    <button class="option" data-type="doc">üìÑ DOCX ‚Üî PDF (M√¥ ph·ªèng)</button>
    <button class="option" data-type="image">üñº ·∫¢nh ‚Üî JPG/PNG</button>
  </div>

  <input type="file" id="fileInput" accept="video/*,image/*,.docx,.pdf">
  <button class="action-btn" id="convertBtn">B·∫Øt ƒë·∫ßu chuy·ªÉn ƒë·ªïi</button>

  <div id="progress"></div>
  <a id="download" download>‚¨áÔ∏è T·∫£i file k·∫øt qu·∫£</a>
</div>

<script>
  // Import FFmpeg ƒë√∫ng c√°ch cho version 0.12.x
  const { FFmpeg } = FFmpegWASM;
  const { fetchFile, toBlobURL } = FFmpegWASM;

  const buttons = document.querySelectorAll(".option");
  const fileInput = document.getElementById("fileInput");
  const convertBtn = document.getElementById("convertBtn");
  const progress = document.getElementById("progress");
  const download = document.getElementById("download");

  let selected = null;
  let ffmpegInstance = null;

  buttons.forEach(btn => {
    btn.addEventListener("click", () => {
      buttons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      selected = btn.dataset.type;
      progress.textContent = "";
      download.style.display = "none";
      // X√≥a error n·∫øu c√≥
      const errorDiv = document.querySelector(".error");
      if (errorDiv) errorDiv.remove();
    });
  });

  convertBtn.addEventListener("click", async () => {
    const file = fileInput.files[0];
    if (!selected) {
      showError("Vui l√≤ng ch·ªçn lo·∫°i chuy·ªÉn ƒë·ªïi.");
      return;
    }
    if (!file) {
      showError("Vui l√≤ng ch·ªçn file.");
      return;
    }

    // Ki·ªÉm tra lo·∫°i file
    const ext = file.name.split('.').pop().toLowerCase();
    if (selected === "video" && !file.type.startsWith('video/')) {
      showError("Vui l√≤ng ch·ªçn file video (MP4, AVI, MOV khuy·∫øn ngh·ªã).");
      return;
    }
    if (selected === "image" && !file.type.startsWith('image/')) {
      showError("Vui l√≤ng ch·ªçn file ·∫£nh (JPG, PNG).");
      return;
    }
    if (selected === "doc" && !['docx', 'pdf'].includes(ext)) {
      showError("Vui l√≤ng ch·ªçn file DOCX ho·∫∑c PDF.");
      return;
    }

    // Ki·ªÉm tra k√≠ch th∆∞·ªõc file (gi·ªõi h·∫°n 100MB cho video/image ƒë·ªÉ tr√°nh crash)
    if (file.size > 100 * 1024 * 1024) {
      showError("File qu√° l·ªõn (>100MB). Th·ª≠ file nh·ªè h∆°n.");
      return;
    }

    progress.textContent = "‚è≥ ƒêang x·ª≠ l√Ω...";
    download.style.display = "none";
    // X√≥a error
    const errorDiv = document.querySelector(".error");
    if (errorDiv) errorDiv.remove();

    try {
      if (selected === "image") {
        await convertImage(file, ext);
      } else if (selected === "video") {
        await convertVideo(file, ext);
      } else if (selected === "doc") {
        await convertDoc(file, ext);
      }
    } catch (err) {
      console.error("L·ªói chi ti·∫øt:", err);
      progress.textContent = "";
      showError(`‚ùå L·ªói: ${err.message}. Ki·ªÉm tra console (F12) ƒë·ªÉ xem chi ti·∫øt.`);
    }
  });

  async function convertImage(file, ext) {
    return new Promise((resolve, reject) => {
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");
      const img = new Image();
      img.onload = () => {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
        // Chuy·ªÉn ƒë·ªïi: N·∫øu PNG ‚Üí JPG, ng∆∞·ª£c l·∫°i JPG ‚Üí PNG
        const isPng = ext === "png";
        const newType = isPng ? "image/jpeg" : "image/png";
        const newExt = isPng ? "jpg" : "png";
        canvas.toBlob(blob => {
          if (!blob) reject(new Error("Kh√¥ng t·∫°o ƒë∆∞·ª£c blob ·∫£nh."));
          const url = URL.createObjectURL(blob);
          download.href = url;
          download.download = `converted.${newExt}`;
          download.style.display = "inline-block";
          progress.textContent = "‚úÖ Ho√†n t·∫•t!";
          resolve();
        }, newType, 0.9); // Quality 90% cho JPG
      };
      img.onerror = () => reject(new Error("Kh√¥ng load ƒë∆∞·ª£c ·∫£nh. Ki·ªÉm tra ƒë·ªãnh d·∫°ng."));
      img.src = URL.createObjectURL(file);
    });
  }

  async function convertVideo(file, ext) {
    progress.textContent = "üì• ƒêang load FFmpeg... (L·∫ßn ƒë·∫ßu c√≥ th·ªÉ m·∫•t 10-30s)";
    ffmpegInstance = new FFmpeg();
    const baseURL = 'https://unpkg.com/@ffmpeg/core@0.12.6/dist/umd';
    await ffmpegInstance.load({
      coreURL: await toBlobURL(`${baseURL}/ffmpeg-core.js`, 'text/javascript'),
      wasmURL: await toBlobURL(`${baseURL}/ffmpeg-core.wasm`, 'application/wasm'),
    });

    const inputName = `input.${ext}`;
    ffmpegInstance.FS('writeFile', inputName, await fetchFile(file));
    progress.textContent = "üîÑ ƒêang chuy·ªÉn video sang GIF...";

    // Command FFmpeg: Gi·∫£m FPS=10, scale=320x?, Lanczos filter cho ch·∫•t l∆∞·ª£ng t·ªët
    await ffmpegInstance.run(
      '-i', inputName,
      '-vf', 'fps=10,scale=320:-1:flags=lanczos',
      '-t', '10', // Gi·ªõi h·∫°n 10s ƒë·∫ßu ƒë·ªÉ tr√°nh file GIF qu√° l·ªõn
      'output.gif'
    );

    const data = ffmpegInstance.FS('readFile', 'output.gif');
    const blob = new Blob([data.buffer], { type: 'image/gif' });
    const url = URL.createObjectURL(blob);
    download.href = url;
    download.download = "output.gif";
    download.style.display = "inline-block";
    progress.textContent = "‚úÖ Ho√†n t·∫•t! (GIF c√≥ th·ªÉ ng·∫Øn n·∫øu video d√†i)";

    // Cleanup
    ffmpegInstance.exit();
    ffmpegInstance = null;
  }

  async function convertDoc(file, ext) {
    progress.textContent = "‚öôÔ∏è ƒêang m√¥ ph·ªèng chuy·ªÉn ƒë·ªïi (3s)... (Ch∆∞a c√≥ API th·ª±c t·∫ø cho DOCX/PDF trong browser).";
    await new Promise(r => setTimeout(r, 3000));
    const outputExt = ext === "pdf" ? "docx" : "pdf";
    const blob = new Blob([
      `N·ªôi dung mock cho file ${outputExt} t·ª´ ${file.name}.\n\n` +
      `ƒê·ªÉ convert th·ª±c t·∫ø, c·∫ßn th∆∞ vi·ªán nh∆∞ Mammoth.js (DOCX‚ÜíHTML) ho·∫∑c pdf-lib (PDF edit), ` +
      `nh∆∞ng browser h·∫°n ch·∫ø. G·ª£i √Ω d√πng tool online nh∆∞ SmallPDF.`
    ], { type: "text/plain" });
    const url = URL.createObjectURL(blob);
    download.href = url;
    download.download = `output.${outputExt}`;
    download.style.display = "inline-block";
    progress.textContent = "‚úÖ Ho√†n t·∫•t m√¥ ph·ªèng!";
  }

  function showError(message) {
    progress.textContent = "";
    const errorDiv = document.createElement("div");
    errorDiv.className = "error";
    errorDiv.textContent = message;
    const card = document.querySelector(".card");
    card.appendChild(errorDiv);
  }

  // Cleanup URL khi unload trang
  window.addEventListener('beforeunload', () => {
    if (ffmpegInstance) ffmpegInstance.exit();
  });
</script>
</body>
</html>
