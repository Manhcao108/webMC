<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Trung t√¢m chuy·ªÉn ƒë·ªïi file</title>
  <!-- FFmpeg version 0.10.1 ·ªïn ƒë·ªãnh -->
  <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.10.1/dist/ffmpeg.min.js"></script>
  <style>
    body {
      font-family: "Inter", sans-serif;
      background: linear-gradient(135deg, #f5f7fa, #e4ecf7);
      text-align: center;
      margin: 0;
      padding: 40px 20px;
      color: #333;
    }
    h1 {
      color: #3b82f6;
      margin-bottom: 10px;
      font-size: 2rem;
    }
    p {
      color: #555;
      margin-bottom: 25px;
    }
    .card {
      background: #fff;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
      max-width: 500px;
      margin: auto;
    }
    .options {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 20px;
    }
    button.option {
      background: #f3f4f6;
      border: 1px solid #d1d5db;
      padding: 12px;
      border-radius: 10px;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s;
    }
    button.option:hover, button.option.active {
      background: #3b82f6;
      color: #fff;
      border-color: #3b82f6;
      transform: scale(1.03);
    }
    input[type=file], .action-btn {
      margin-top: 15px;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: 1rem;
      width: 100%;
      max-width: 320px;
    }
    .action-btn {
      background: #3b82f6;
      color: white;
      border: none;
      cursor: pointer;
      transition: 0.3s;
    }
    .action-btn:hover {
      background: #2563eb;
    }
    .action-btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    #progress {
      margin-top: 15px;
      color: #555;
      font-style: italic;
    }
    a#download {
      display: none;
      margin-top: 15px;
      text-decoration: none;
      background: #10b981;
      color: white;
      padding: 10px 18px;
      border-radius: 10px;
    }
    a#download:hover {
      background: #059669;
    }
    .error {
      color: #ef4444;
      background: #fef2f2;
      padding: 10px;
      border-radius: 8px;
      margin-top: 10px;
      border: 1px solid #fecaca;
    }
  </style>
</head>
<body>
<h1>üîÑ Trung t√¢m chuy·ªÉn ƒë·ªïi file</h1>
<p>Chuy·ªÉn ƒë·ªïi nhanh c√°c ƒë·ªãnh d·∫°ng ph·ªï bi·∫øn ngay trong tr√¨nh duy·ªát. (L∆∞u √Ω: Video ‚Üí GIF c√≥ th·ªÉ m·∫•t 10-30s l·∫ßn ƒë·∫ßu do load FFmpeg ~30MB).</p>

<div class="card">
  <div class="options">
    <button class="option" data-type="video">üé¨ Video ‚Üí GIF</button>
    <button class="option" data-type="doc">üìÑ DOCX ‚Üî PDF (M√¥ ph·ªèng)</button>
    <button class="option" data-type="image">üñº ·∫¢nh ‚Üî JPG/PNG</button>
  </div>

  <input type="file" id="fileInput" accept="video/*,image/*,.docx,.pdf">
  <button class="action-btn" id="convertBtn">B·∫Øt ƒë·∫ßu chuy·ªÉn ƒë·ªïi</button>

  <div id="progress"></div>
  <a id="download" download>‚¨áÔ∏è T·∫£i file k·∫øt qu·∫£</a>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    console.log("DOM ready, init app...");
    
    const buttons = document.querySelectorAll(".option");
    const fileInput = document.getElementById("fileInput");
    const convertBtn = document.getElementById("convertBtn");
    const progress = document.getElementById("progress");
    const download = document.getElementById("download");

    let selected = null;
    let ffmpegInstance = null;

    // Event cho option buttons (ch·∫°y ngay)
    buttons.forEach(btn => {
      btn.addEventListener("click", () => {
        console.log("Option clicked:", btn.dataset.type); // Debug
        buttons.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        selected = btn.dataset.type;
        progress.textContent = "";
        download.style.display = "none";
        const errorDiv = document.querySelector(".error");
        if (errorDiv) errorDiv.remove();
        convertBtn.disabled = false;
      });
    });

    // Event cho convert button (ch·∫°y ngay)
    convertBtn.addEventListener("click", async () => {
      console.log("Convert clicked, selected:", selected); // Debug
      const file = fileInput.files[0];
      if (!selected) {
        showError("Vui l√≤ng ch·ªçn lo·∫°i chuy·ªÉn ƒë·ªïi.");
        return;
      }
      if (!file) {
        showError("Vui l√≤ng ch·ªçn file.");
        return;
      }

      const ext = file.name.split('.').pop().toLowerCase();
      if (selected === "video" && !file.type.startsWith('video/')) {
        showError("Vui l√≤ng ch·ªçn file video (MP4 khuy·∫øn ngh·ªã).");
        return;
      }
      if (selected === "image" && !file.type.startsWith('image/')) {
        showError("Vui l√≤ng ch·ªçn file ·∫£nh (JPG, PNG).");
        return;
      }
      if (selected === "doc" && !['docx', 'pdf'].includes(ext)) {
        showError("Vui l√≤ng ch·ªçn file DOCX ho·∫∑c PDF.");
        return;
      }

      if (file.size > 100 * 1024 * 1024) {
        showError("File qu√° l·ªõn (>100MB). Th·ª≠ file nh·ªè h∆°n.");
        return;
      }

      convertBtn.disabled = true;
      convertBtn.textContent = "ƒêang x·ª≠ l√Ω...";
      progress.textContent = "‚è≥ ƒêang x·ª≠ l√Ω...";
      download.style.display = "none";
      const errorDiv = document.querySelector(".error");
      if (errorDiv) errorDiv.remove();

      try {
        if (selected === "image") {
          await convertImage(file, ext);
        } else if (selected === "video") {
          await convertVideo(file, ext);
        } else if (selected === "doc") {
          await convertDoc(file, ext);
        }
      } catch (err) {
        console.error("L·ªói chi ti·∫øt:", err);
        progress.textContent = "";
        showError(`‚ùå L·ªói: ${err.message}. Ki·ªÉm tra console (F12).`);
      } finally {
        convertBtn.disabled = false;
        convertBtn.textContent = "B·∫Øt ƒë·∫ßu chuy·ªÉn ƒë·ªïi";
      }
    });

    async function convertImage(file, ext) {
      console.log("Converting image...");
      return new Promise((resolve, reject) => {
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        const img = new Image();
        img.onload = () => {
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);
          const isPng = ext === "png";
          const newType = isPng ? "image/jpeg" : "image/png";
          const newExt = isPng ? "jpg" : "png";
          canvas.toBlob(blob => {
            if (!blob) reject(new Error("Kh√¥ng t·∫°o ƒë∆∞·ª£c blob ·∫£nh."));
            const url = URL.createObjectURL(blob);
            download.href = url;
            download.download = `converted.${newExt}`;
            download.style.display = "inline-block";
            progress.textContent = "‚úÖ Ho√†n t·∫•t!";
            resolve();
          }, newType, 0.9);
        };
        img.onerror = () => reject(new Error("Kh√¥ng load ƒë∆∞·ª£c ·∫£nh."));
        img.src = URL.createObjectURL(file);
      });
    }

    async function convertVideo(file, ext) {
      console.log("Converting video, checking FFmpeg...");
      // Check FFmpeg an to√†n
      if (typeof window.FFmpeg === 'undefined') {
        throw new Error("Th∆∞ vi·ªán FFmpeg ch∆∞a load. Th·ª≠ reload trang ho·∫∑c ki·ªÉm tra m·∫°ng.");
      }

      progress.textContent = "üì• ƒêang load FFmpeg... (L·∫ßn ƒë·∫ßu m·∫•t 10-30s)";
      
      // Access createFFmpeg an to√†n
      const { createFFmpeg, fetchFile } = window.FFmpeg;
      if (typeof createFFmpeg !== 'function') {
        throw new Error("FFmpeg kh√¥ng c√≥ method createFFmpeg. Th·ª≠ version kh√°c.");
      }

      // Retry load
      for (let attempt = 1; attempt <= 3; attempt++) {
        try {
          ffmpegInstance = createFFmpeg({ log: true });
          await ffmpegInstance.load({
            coreURL: 'https://unpkg.com/@ffmpeg/core@0.10.0/dist/ffmpeg-core.js',
            wasmURL: 'https://unpkg.com/@ffmpeg/core@0.10.0/dist/ffmpeg-core.wasm',
          });
          console.log("FFmpeg loaded OK");
          break;
        } catch (loadErr) {
          console.warn(`Load FFmpeg attempt ${attempt} failed:`, loadErr);
          if (attempt === 3) throw new Error(`Kh√¥ng load ƒë∆∞·ª£c FFmpeg sau 3 l·∫ßn. L·ªói: ${loadErr.message}`);
          await new Promise(r => setTimeout(r, 2000));
        }
      }

      const inputName = `input.${ext}`;
      ffmpegInstance.FS('writeFile', inputName, await fetchFile(file));
      progress.textContent = "üîÑ ƒêang chuy·ªÉn video sang GIF...";

      await ffmpegInstance.run(
        '-i', inputName,
        '-vf', 'fps=10,scale=320:-1:flags=lanczos',
        '-t', '10',
        'output.gif'
      );

      const data = ffmpegInstance.FS('readFile', 'output.gif');
      const blob = new Blob([data.buffer], { type: 'image/gif' });
      const url = URL.createObjectURL(blob);
      download.href = url;
      download.download = "output.gif";
      download.style.display = "inline-block";
      progress.textContent = "‚úÖ Ho√†n t·∫•t! (GIF 10s ƒë·∫ßu video)";

      ffmpegInstance.exit();
      ffmpegInstance = null;
    }

    async function convertDoc(file, ext) {
      console.log("Converting doc (mock)...");
      progress.textContent = "‚öôÔ∏è ƒêang m√¥ ph·ªèng chuy·ªÉn ƒë·ªïi (3s)...";
      await new Promise(r => setTimeout(r, 3000));
      const outputExt = ext === "pdf" ? "docx" : "pdf";
      const blob = new Blob([
        `N·ªôi dung mock cho ${outputExt} t·ª´ ${file.name}.\n\nD√πng tool online nh∆∞ SmallPDF cho convert th·∫≠t.`
      ], { type: "text/plain" });
      const url = URL.createObjectURL(blob);
      download.href = url;
      download.download = `output.${outputExt}`;
      download.style.display = "inline-block";
      progress.textContent = "‚úÖ Ho√†n t·∫•t m√¥ ph·ªèng!";
    }

    function showError(message) {
      progress.textContent = "";
      const errorDiv = document.createElement("div");
      errorDiv.className = "error";
      errorDiv.textContent = message;
      document.querySelector(".card").appendChild(errorDiv);
      convertBtn.disabled = false;
      convertBtn.textContent = "B·∫Øt ƒë·∫ßu chuy·ªÉn ƒë·ªïi";
    }

    window.addEventListener('beforeunload', () => {
      if (ffmpegInstance) ffmpegInstance.exit();
    });

    console.log("App init OK! Buttons ready.");
  });
</script>
</body>
</html>
