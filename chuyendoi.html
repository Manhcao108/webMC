<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trung t√¢m chuy·ªÉn ƒë·ªïi file - D·ªÖ d√πng</title>
  <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.4/dist/ffmpeg.min.js"></script>
  <style>
    body {
      font-family: "Inter", sans-serif;
      background: linear-gradient(135deg, #f5f7fa, #e4ecf7);
      text-align: center;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    h1 {
      color: #3b82f6;
      margin-bottom: 10px;
      font-size: 1.8rem;
    }
    p {
      color: #555;
      margin-bottom: 20px;
    }
    .card {
      background: #fff;
      padding: 25px;
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
      max-width: 500px;
      margin: auto;
    }
    .options {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 15px;
    }
    button.option {
      background: #f3f4f6;
      border: 1px solid #d1d5db;
      padding: 12px;
      border-radius: 10px;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s;
    }
    button.option:hover, button.option.active {
      background: #3b82f6;
      color: #fff;
      border-color: #3b82f6;
      transform: scale(1.02);
    }
    #fileInput, .action-btn {
      margin: 10px 0;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: 1rem;
      width: 100%;
      max-width: 320px;
      box-sizing: border-box;
    }
    .action-btn {
      background: #3b82f6;
      color: white;
      border: none;
      cursor: pointer;
      transition: 0.3s;
    }
    .action-btn:hover:not(:disabled), .action-btn:disabled {
      background: #2563eb;
    }
    .action-btn:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }
    #dropZone {
      border: 2px dashed #ccc;
      border-radius: 10px;
      padding: 20px;
      margin: 10px 0;
      background: #f9f9f9;
      cursor: pointer;
      transition: all 0.3s;
    }
    #dropZone:hover, #dropZone.dragover {
      border-color: #3b82f6;
      background: #f0f8ff;
    }
    #dropZone p {
      margin: 0;
      color: #666;
    }
    #progress {
      margin: 15px 0;
      color: #555;
      font-style: italic;
    }
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 5px;
    }
    .progress-fill {
      height: 100%;
      background: #3b82f6;
      width: 0%;
      transition: width 0.3s;
    }
    a#download {
      display: none;
      margin-top: 15px;
      text-decoration: none;
      background: #10b981;
      color: white;
      padding: 12px 20px;
      border-radius: 10px;
      display: inline-block;
    }
    a#download:hover {
      background: #059669;
    }
    .note {
      font-size: 0.8rem;
      color: #888;
      margin-top: 5px;
    }
    @media (max-width: 600px) {
      body { padding: 10px; }
      h1 { font-size: 1.5rem; }
      .card { padding: 15px; }
    }
  </style>
</head>
<body>
<h1>üîÑ Trung t√¢m chuy·ªÉn ƒë·ªïi file</h1>
<p>Chuy·ªÉn ƒë·ªïi nhanh, d·ªÖ d√πng. Ch·ªâ c·∫ßn ch·ªçn file v√† lo·∫°i! (H·ªó tr·ª£ ·∫£nh JPG/PNG v√† HEIC ‚Üí JPG)</p>

<div class="card">
  <div class="options">
    <button class="option" data-type="image">üñº ·∫¢nh ‚Üî JPG/PNG</button>
    <button class="option" data-type="image-heic">üñº HEIC ‚Üí JPG/PNG</button>
  </div>

  <div id="dropZone">
    <p>K√©o th·∫£ file v√†o ƒë√¢y ho·∫∑c <label for="fileInput" style="color: #3b82f6; cursor: pointer;">ch·ªçn file</label></p>
  </div>
  <input type="file" id="fileInput" accept="image/*,.heic" style="display: none;">

  <button class="action-btn" id="convertBtn">B·∫Øt ƒë·∫ßu chuy·ªÉn ƒë·ªïi</button>

  <div id="progress"></div>
  <div class="progress-bar" id="progressBar" style="display: none;">
    <div class="progress-fill" id="progressFill"></div>
  </div>
  <a id="download" download>‚¨áÔ∏è T·∫£i file k·∫øt qu·∫£</a>
</div>

<script>
  const buttons = document.querySelectorAll(".option");
  const fileInput = document.getElementById("fileInput");
  const convertBtn = document.getElementById("convertBtn");
  const progress = document.getElementById("progress");
  const download = document.getElementById("download");
  const dropZone = document.getElementById("dropZone");
  const progressBar = document.getElementById("progressBar");
  const progressFill = document.getElementById("progressFill");

  let selected = null;
  let currentFile = null;

  buttons.forEach(btn => {
    btn.addEventListener("click", () => {
      buttons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      selected = btn.dataset.type;
      resetUI();
    });
  });

  dropZone.addEventListener("click", () => fileInput.click());
  fileInput.addEventListener("change", (e) => {
    if (e.target.files[0]) {
      currentFile = e.target.files[0];
      updateFileName(currentFile.name);
    }
  });

  dropZone.addEventListener("dragover", (e) => {
    e.preventDefault();
    dropZone.classList.add("dragover");
  });
  dropZone.addEventListener("dragleave", () => dropZone.classList.remove("dragover"));
  dropZone.addEventListener("drop", (e) => {
    e.preventDefault();
    dropZone.classList.remove("dragover");
    if (e.dataTransfer.files[0]) {
      currentFile = e.dataTransfer.files[0];
      fileInput.files = e.dataTransfer.files;
      updateFileName(currentFile.name);
    }
  });

  function updateFileName(name) {
    dropZone.innerHTML = `<p>File: ${name} (K√©o th·∫£ file m·ªõi n·∫øu mu·ªën thay)</p>`;
  }

  function resetUI() {
    progress.textContent = "";
    progressBar.style.display = "none";
    progressFill.style.width = "0%";
    download.style.display = "none";
    convertBtn.disabled = false;
  }

  function showProgress(text, percent = 0) {
    progress.textContent = text;
    progressBar.style.display = "block";
    progressFill.style.width = percent + "%";
  }

  function showAlert(msg, isError = false) {
    alert((isError ? "‚ùå " : "‚ÑπÔ∏è ") + msg);
  }

  convertBtn.addEventListener("click", async () => {
    if (!selected) return showAlert("Vui l√≤ng ch·ªçn lo·∫°i chuy·ªÉn ƒë·ªïi.");
    if (!currentFile) return showAlert("Vui l√≤ng ch·ªçn file.");

    const ext = currentFile.name.split('.').pop().toLowerCase();
    let valid = false;
    if (selected === "image" && (ext === "jpg" || ext === "jpeg" || ext === "png")) valid = true;
    else if (selected === "image-heic" && ext === "heic") valid = true;
    if (!valid) return showAlert(`File kh√¥ng ph√π h·ª£p! ${selected === "image-heic" ? "C·∫ßn file HEIC." : "C·∫ßn JPG/PNG."}`, true);

    if (currentFile.size > 50 * 1024 * 1024) return showAlert("‚ùå File >50MB! Ch·ªçn file nh·ªè h∆°n ƒë·ªÉ tr√°nh crash.", true);

    convertBtn.disabled = true;
    showProgress("‚è≥ ƒêang x·ª≠ l√Ω...", 10);
    download.style.display = "none";

    try {
      if (selected === "image") {
        showProgress("üîÑ ƒêang chuy·ªÉn ·∫£nh...", 50);
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        const img = new Image();
        img.onload = () => {
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);
          const isJpg = ext === "jpg" || ext === "jpeg";
          const newType = isJpg ? "image/png" : "image/jpeg";
          const newExt = isJpg ? "png" : "jpg";
          canvas.toBlob(blob => {
            const url = URL.createObjectURL(blob);
            download.href = url;
            download.download = `converted.${newExt}`;
            download.style.display = "inline-block";
            showProgress("‚úÖ Ho√†n t·∫•t!", 100);
            convertBtn.disabled = false;
          }, newType);
        };
        img.onerror = () => {
          showAlert("L·ªói load ·∫£nh.", true);
          convertBtn.disabled = false;
        };
        img.src = URL.createObjectURL(currentFile);
      } else if (selected === "image-heic") {
        showProgress("üîÑ ƒêang chuy·ªÉn HEIC sang JPG...", 50);
        const { createFFmpeg, fetchFile } = FFmpeg;
        const ffmpeg = createFFmpeg({ log: true });
        await ffmpeg.load();
        ffmpeg.FS('writeFile', 'input.heic', await fetchFile(currentFile));
        await ffmpeg.run('-i', 'input.heic', 'output.jpg');
        const data = ffmpeg.FS('readFile', 'output.jpg');
        const blob = new Blob([data.buffer], { type: 'image/jpeg' });
        const url = URL.createObjectURL(blob);
        download.href = url;
        download.download = 'converted.jpg';
        download.style.display = "inline-block";
        showProgress("‚úÖ Ho√†n t·∫•t chuy·ªÉn ƒë·ªïi HEIC!", 100);
        ffmpeg.exit();
        convertBtn.disabled = false;
      }
    } catch (err) {
      console.error("L·ªói chuy·ªÉn ƒë·ªïi:", err);
      showProgress("‚ùå L·ªói x·∫£y ra! Th·ª≠ l·∫°i v·ªõi file nh·ªè h∆°n.", 0);
      showAlert(`L·ªói: ${err.message || "Kh√¥ng x√°c ƒë·ªãnh"}. Ki·ªÉm tra file v√† browser (Chrome khuy·∫øn ngh·ªã).`, true);
      if (typeof ffmpeg !== 'undefined' && ffmpeg.exit) ffmpeg.exit();
    }
  });
</script>
</body>
</html>
