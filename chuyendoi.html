<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trung t√¢m chuy·ªÉn ƒë·ªïi file - D·ªÖ d√πng</title>
  <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.4/dist/ffmpeg.min.js"></script>
  <style>
    body {
      font-family: "Inter", sans-serif;
      background: linear-gradient(135deg, #f5f7fa, #e4ecf7);
      text-align: center;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    h1 {
      color: #3b82f6;
      margin-bottom: 10px;
      font-size: 1.8rem;
    }
    p {
      color: #555;
      margin-bottom: 20px;
    }
    .card {
      background: #fff;
      padding: 25px;
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
      max-width: 500px;
      margin: auto;
    }
    .options {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 15px;
    }
    button.option {
      background: #f3f4f6;
      border: 1px solid #d1d5db;
      padding: 12px;
      border-radius: 10px;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s;
    }
    button.option:hover, button.option.active {
      background: #3b82f6;
      color: #fff;
      border-color: #3b82f6;
      transform: scale(1.02);
    }
    #fileInput, .action-btn, input[type=number] {
      margin: 10px 0;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: 1rem;
      width: 100%;
      max-width: 320px;
      box-sizing: border-box;
    }
    input[type=number] {
      width: 120px;
      display: inline-block;
      margin: 5px;
    }
    .trim-options {
      display: none;
      margin: 10px 0;
      background: #f9f9f9;
      padding: 10px;
      border-radius: 8px;
    }
    .trim-options label {
      font-size: 0.9rem;
      color: #666;
      margin-right: 5px;
    }
    .action-btn {
      background: #3b82f6;
      color: white;
      border: none;
      cursor: pointer;
      transition: 0.3s;
    }
    .action-btn:hover, .action-btn:disabled {
      background: #2563eb;
    }
    .action-btn:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }
    #dropZone {
      border: 2px dashed #ccc;
      border-radius: 10px;
      padding: 20px;
      margin: 10px 0;
      background: #f9f9f9;
      cursor: pointer;
      transition: all 0.3s;
    }
    #dropZone:hover, #dropZone.dragover {
      border-color: #3b82f6;
      background: #f0f8ff;
    }
    #dropZone p {
      margin: 0;
      color: #666;
    }
    #progress {
      margin: 15px 0;
      color: #555;
      font-style: italic;
    }
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 5px;
    }
    .progress-fill {
      height: 100%;
      background: #3b82f6;
      width: 0%;
      transition: width 0.3s;
    }
    a#download {
      display: none;
      margin-top: 15px;
      text-decoration: none;
      background: #10b981;
      color: white;
      padding: 12px 20px;
      border-radius: 10px;
      display: inline-block;
    }
    a#download:hover {
      background: #059669;
    }
    .note {
      font-size: 0.8rem;
      color: #888;
      margin-top: 5px;
    }
    @media (max-width: 600px) {
      body { padding: 10px; }
      h1 { font-size: 1.5rem; }
      .card { padding: 15px; }
      input[type=number] { width: 100px; }
    }
  </style>
</head>
<body>
<h1>üîÑ Trung t√¢m chuy·ªÉn ƒë·ªïi file</h1>
<p>Chuy·ªÉn ƒë·ªïi nhanh, d·ªÖ d√πng. Ch·ªâ c·∫ßn ch·ªçn file v√† lo·∫°i! (Video: Gi·ªõi h·∫°n <50MB, <60s)</p>

<div class="card">
  <div class="options">
    <button class="option" data-type="video">üé¨ Video ‚Üí GIF</button>
    <button class="option" data-type="doc">üìÑ DOCX ‚Üî PDF</button>
    <button class="option" data-type="image">üñº ·∫¢nh ‚Üî JPG/PNG</button>
  </div>

  <div id="dropZone">
    <p>K√©o th·∫£ file v√†o ƒë√¢y ho·∫∑c <label for="fileInput" style="color: #3b82f6; cursor: pointer;">ch·ªçn file</label></p>
  </div>
  <input type="file" id="fileInput" accept="image/*,video/*,.docx,.pdf" style="display: none;">

  <div class="trim-options" id="trimOptions">
    <label for="startTime">B·∫Øt ƒë·∫ßu t·ª´ gi√¢y:</label>
    <input type="number" id="startTime" min="0" max="60" value="0" step="0.1">
    <label for="duration">ƒê·ªô d√†i c·∫Øt (gi√¢y):</label>
    <input type="number" id="duration" min="1" max="60" value="10" step="0.1">
    <p class="note">M·∫∑c ƒë·ªãnh: C·∫Øt 10 gi√¢y t·ª´ ƒë·∫ßu. Video d√†i >60s s·∫Ω b·ªã ch·∫∑n ƒë·ªÉ tr√°nh lag.</p>
  </div>

  <button class="action-btn" id="convertBtn">B·∫Øt ƒë·∫ßu chuy·ªÉn ƒë·ªïi</button>

  <div id="progress"></div>
  <div class="progress-bar" id="progressBar" style="display: none;">
    <div class="progress-fill" id="progressFill"></div>
  </div>
  <a id="download" download>‚¨áÔ∏è T·∫£i file k·∫øt qu·∫£</a>
</div>

<script>
  const buttons = document.querySelectorAll(".option");
  const fileInput = document.getElementById("fileInput");
  const convertBtn = document.getElementById("convertBtn");
  const progress = document.getElementById("progress");
  const download = document.getElementById("download");
  const dropZone = document.getElementById("dropZone");
  const progressBar = document.getElementById("progressBar");
  const progressFill = document.getElementById("progressFill");
  const trimOptions = document.getElementById("trimOptions");
  const startTimeInput = document.getElementById("startTime");
  const durationInput = document.getElementById("duration");

  let selected = null;
  let currentFile = null;
  let videoDuration = 0; // ƒê·ªÉ l∆∞u th·ªùi l∆∞·ª£ng video

  // Ch·ªçn lo·∫°i
  buttons.forEach(btn => {
    btn.addEventListener("click", () => {
      buttons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      selected = btn.dataset.type;
      trimOptions.style.display = selected === "video" ? "block" : "none";
      resetUI();
    });
  });

  // Drag-drop v√† ch·ªçn file
  dropZone.addEventListener("click", () => fileInput.click());
  fileInput.addEventListener("change", (e) => {
    if (e.target.files[0]) {
      currentFile = e.target.files[0];
      updateFileName(currentFile.name);
      if (selected === "video") probeVideoDuration();
    }
  });

  dropZone.addEventListener("dragover", (e) => {
    e.preventDefault();
    dropZone.classList.add("dragover");
  });
  dropZone.addEventListener("dragleave", () => dropZone.classList.remove("dragover"));
  dropZone.addEventListener("drop", (e) => {
    e.preventDefault();
    dropZone.classList.remove("dragover");
    if (e.dataTransfer.files[0]) {
      currentFile = e.dataTransfer.files[0];
      fileInput.files = e.dataTransfer.files;
      updateFileName(currentFile.name);
      if (selected === "video") probeVideoDuration();
    }
  });

  function updateFileName(name) {
    dropZone.innerHTML = `<p>File: ${name} (K√©o th·∫£ file m·ªõi n·∫øu mu·ªën thay)</p>`;
  }

  function resetUI() {
    progress.textContent = "";
    progressBar.style.display = "none";
    progressFill.style.width = "0%";
    download.style.display = "none";
    convertBtn.disabled = false;
  }

  function showProgress(text, percent = 0) {
    progress.textContent = text;
    progressBar.style.display = "block";
    progressFill.style.width = percent + "%";
  }

  function showAlert(msg, isError = false) {
    alert((isError ? "‚ùå " : "‚ÑπÔ∏è ") + msg);
  }

  // Probe th·ªùi l∆∞·ª£ng video b·∫±ng FFmpeg
  async function probeVideoDuration() {
    if (!currentFile || selected !== "video") return;
    try {
      showProgress("üîç ƒêang ki·ªÉm tra video...", 5);
      const { FFmpeg } = FFmpeg; // S·ª≠ d·ª•ng FFmpeg ƒë·ªÉ probe
      const ffmpeg = FFmpeg.createFFmpeg({ log: true });
      await ffmpeg.load();
      const inputName = `input.${currentFile.name.split('.').pop().toLowerCase()}`;
      ffmpeg.FS('writeFile', inputName, await FFmpeg.fetchFile(currentFile));
      const { stderr } = await ffmpeg.run('-i', inputName, '-hide_banner', '-f', 'null', '-');
      // Parse duration t·ª´ stderr (d·∫°ng "Duration: 00:00:30.00")
      const durationMatch = stderr.match(/Duration: (\d{2}):(\d{2}):(\d{2})\.(\d{2})/);
      if (durationMatch) {
        const hours = parseInt(durationMatch[1]);
        const mins = parseInt(durationMatch[2]);
        const secs = parseInt(durationMatch[3]);
        videoDuration = hours * 3600 + mins * 60 + secs;
        showProgress(`Video d√†i ${videoDuration}s. S·∫µn s√†ng c·∫Øt!`, 10);
        // Update max cho inputs
        startTimeInput.max = videoDuration;
        durationInput.max = videoDuration;
      } else {
        videoDuration = 0;
        showAlert("Kh√¥ng detect ƒë∆∞·ª£c th·ªùi l∆∞·ª£ng video.", true);
      }
      // Cleanup
      ffmpeg.exit();
    } catch (err) {
      console.error(err);
      showAlert("L·ªói ki·ªÉm tra video: " + err.message, true);
    }
  }

  // Chuy·ªÉn ƒë·ªïi
  convertBtn.addEventListener("click", async () => {
    if (!selected) return showAlert("Vui l√≤ng ch·ªçn lo·∫°i chuy·ªÉn ƒë·ªïi.");
    if (!currentFile) return showAlert("Vui l√≤ng ch·ªçn file.");

    // Ki·ªÉm tra file type
    const ext = currentFile.name.split('.').pop().toLowerCase();
    let valid = false;
    if (selected === "image" && (ext === "jpg" || ext === "jpeg" || ext === "png")) valid = true;
    else if (selected === "video" && (ext === "mp4" || ext === "avi" || ext === "mov")) valid = true;
    else if (selected === "doc" && (ext === "docx" || ext === "pdf")) valid = true;
    if (!valid) return showAlert(`File kh√¥ng ph√π h·ª£p! ${selected === "image" ? "C·∫ßn JPG/PNG." : selected === "video" ? "C·∫ßn MP4/AVI/MOV." : "C·∫ßn DOCX/PDF."}`, true);

    // Gi·ªõi h·∫°n chung
    if (currentFile.size > 50 * 1024 * 1024) return showAlert("File qu√° l·ªõn (>50MB)! Ch·ªçn video nh·ªè h∆°n ƒë·ªÉ tr√°nh lag.", true);

    convertBtn.disabled = true;
    showProgress("‚è≥ ƒêang x·ª≠ l√Ω...", 10);
    download.style.display = "none";

    try {
      if (selected === "image") {
        showProgress("üîÑ ƒêang chuy·ªÉn ·∫£nh...", 50);
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        const img = new Image();
        img.onload = () => {
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);
          const isJpg = ext === "jpg" || ext === "jpeg";
          const newType = isJpg ? "image/png" : "image/jpeg";
          const newExt = isJpg ? "png" : "jpg";
          canvas.toBlob(blob => {
            const url = URL.createObjectURL(blob);
            download.href = url;
            download.download = `converted.${newExt}`;
            download.style.display = "inline-block";
            showProgress("‚úÖ Ho√†n t·∫•t!", 100);
            convertBtn.disabled = false;
          }, newType);
        };
        img.src = URL.createObjectURL(currentFile);
      } else if (selected === "video") {
        // Ki·ªÉm tra th·ªùi l∆∞·ª£ng (probe n·∫øu ch∆∞a)
        if (videoDuration === 0) await probeVideoDuration();
        if (videoDuration > 60) return showAlert("Video qu√° d√†i (>60s)! H√£y c·∫Øt ng·∫Øn ho·∫∑c d√πng tool kh√°c.", true);

        const startTime = parseFloat(startTimeInput.value) || 0;
        let duration = parseFloat(durationInput.value) || videoDuration - startTime;
        if (startTime + duration > videoDuration) duration = videoDuration - startTime;
        if (duration < 1) return showAlert("ƒê·ªô d√†i c·∫Øt ph·∫£i >=1 gi√¢y!", true);

        showProgress(`üîÑ ƒêang t·∫£i FFmpeg... (C·∫Øt t·ª´ ${startTime}s, d√†i ${duration}s)`, 20);
        const { createFFmpeg, fetchFile } = FFmpeg;
        const ffmpeg = createFFmpeg({ log: true });
        await ffmpeg.load();
        const inputName = `input.${ext}`;
        ffmpeg.FS('writeFile', inputName, await fetchFile(currentFile));
        showProgress("üîÑ ƒêang c·∫Øt v√† chuy·ªÉn video...", 50);
        // L·ªánh FFmpeg v·ªõi trim: -ss start -t duration
        await ffmpeg.run('-i', inputName, '-ss', startTime.toString(), '-t', duration.toString(), '-vf', 'fps=10,scale=320:-1:flags=lanczos', 'output.gif');
        const data = ffmpeg.FS('readFile', 'output.gif');
        const url =
